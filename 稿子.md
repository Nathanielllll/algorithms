# 1 实习概要

第一二周，主要学习中间件；认识蚂蚁国际各个域之间的业务关系和交互。

第三到五周，在继续了解其他的组件的同时，也开始参与到具体的人传人业务开发当中。

第六到八周，则是参与到了渠道营销的业务代码开发中。除了开发，我还负责补充测试用例。

# 2 业务回顾

那么首先，是我对渠道营销的业务回顾。

## 渠道营销的业务需求

那么，我先说一下我对渠道营销的理解：渠道营销就是对支付渠道的营销。在电子钱包充值页投放广告，告知用户绑定新银行卡并进行充值，用户就可以享受一定的优惠活动，比如充值满200返100。

好，接下来让我们以LZD钱包为例子，介绍一下渠道营销的具体应用。第一张图是LZD钱包的主页，最上面有钱包的余额信息、cash in充值按键。我们点击cash in充值按键，进入了充值页面。在腰封处可以看到可用的支付渠道，以第一个创意为例，我们可以看到200块的最少充值金额、100块的可获得的回扣。然后我们输入具体的金额200块钱，跳转入第三张图，后台会根据我们输入的200块钱金额还有其他一些信息，展示出可用的支付渠道。

那么我们为什么需要渠道营销呢？对钱包来说。最直观也最重要的就是提高绑卡率和钱包用户活跃度。其次，可用完善Lazada PA营销应用产品能力，为后续支付立减等营销玩法打通系统流程。吸引其他没有签约的银行和钱包签约。

## 投放系统改造

接下来，我们谈一下渠道营销的系统设计。可以看到，这是一个投放系统的通用流程，我们不同的投放业务都要经过这样的流程。有些步骤，不同的业务有不同的代码逻辑，系统会根据这个业务特有的***标志码***来进行特有的处理。从左往右对投放系统做一个大致的解释。单元召回：我们的投放系统是按照投放单元来进行投放的，那么首先就要从数据库捞取投放单元。单元定向：系统会根据一定的条件，如投放单元状态、业务时间、租户，筛选出符合要求的投放单元。内容创意召回：系统会捞取投放单元的内容创意。内容创意定向会根据业务特有的条件，来对内容创意进行判断，筛选出符合条件的投放单元。打分决策，会根据业务的条件对内容进行打分。然后在结果重排里面，根据打分结果，反查出对应的投放单元，对投放单元进行排序。接着是补全投放单元的创意，然后对接上游，将结果返回。

渠道营销的诉求是：我们投放的广告信息上，显示的肯定是用户能使用的支付渠道、用户能参加的营销活动、而且显示的支付渠道应该能尽可能提高的绑卡率。原来系统缺乏这些能力，因此会在这次的渠道营销中添加三个定制逻辑，来补充我们的能力。具体的说，在内容创意定向当中，首先我们会调用支付决策平台，进行【支付人群定向？？？】，筛选出符合条件的投放单元；然后，我们会发送**用户id、活动id、渠道信息、充值金额**这些信息给营销平台，让它进行活动咨询，来告诉我们用户是不是能参加这个营销活动，我们会根据返回的结果，筛选掉不符合参加活动条件的投放单元。接下来是打分决策，仍然调用支付决策平台，将用户id、支付渠道发过去，它会根据用户特征、渠道特征等数据，将最有利于提升绑卡率的支付渠道进行打分。

我在渠道营销里面。。。

## 渠道营销的思考

接下来，是我对渠道营销的一些思考。

【定制逻辑沉淀】刚才讲到，渠道营销里面，调用其他系统的接口，是我们针对这个特定业务的定制逻辑。而我们当前目标，就是把这些定制逻辑沉淀到我们系统的通用能力里面。渠道营销第一次实现了投放系统和营销平台的联通，但是将来肯定会有更多的玩法，来使用这些通用能力。以调用营销平台的活动咨询为例，如果以后我们的渠道营销新增支付立减、发礼券这些玩法，都会过活动咨询。现在的渠道营销为这些玩法打通系统流程，而我们目前要做的，就是把这些定制逻辑沉淀下来。

【动态配置】按照现在的模式，如果以后有券核销的需求，就会调用营销平台的券核心，那么就要新增定制逻辑。这可能要先下线原来的业务，再进行重新发布。这不仅十分麻烦，而且可能会影响到我们的正常业务。那么我们是不是可以考虑，对投放系统进行改造，让系统能动态配置新增定制逻辑？这样就可以继续无缝地运行我们的业务代码。

【架构优化】考虑一下，我们投放系统到底是干什么的呢？投放系统的目的是为了触达用户。它可以拉取投放单元，经过简单的定向、创意补全，然后将创意返回给上游。

但是，渠道营销现在做的事情，像调用支付决策系统、营销系统这些定制逻辑，都超出了投放系统的边界。其他业务线也有同样的情况。长远目标来看，我们应该把这些东西都交给推荐平台去做。以后我们只需要调用推荐平台，就可以完成内容创意的定向、打分决策，但是不用关心底层的代码逻辑。

比如：原来需要调用营销系统的活动咨询，就是检查用户是否能参加营销活动。那么推荐平台，是不是可以抽象出一个模板，让投放调用它的时候，无论活动咨询、奖品咨询还是其他的咨询，都能直接返回给是否可用的结果。

又比如：原来需要调用支付决策系统进行打分。以后，投放系统只要去调用推荐系统暴露出来的接口就能完成打分。至于推荐平台怎么样根据不同的业务，去调用下游不同系统，我们都不用关心。

## 人传人活动

OK，接下来是关于人传人活动的分享，我们仍然以举例为先。以香港支付宝为例，第一个页面是推荐奖赏计划的主页，我们点击推荐攻略，就可以看到详细的活动规则。活动规则显示：老用户可以通过WhatsApp/FaceBook等方式，将$2的礼券分享给新用户，新用户点击链接领取礼券。新用户需要完成一个预设的任务：即在72小时内用掉礼券，那么老用户可以获得$10的奖赏和10个印花；新用户可以获得价值$60的券。【在这个case当中，有两个主要的角色：老用户和新用户，我们可以抽象为分享者和被分享者。被分享者需要在72小时内用掉礼券，这是一个预设的被分享者需要完成的任务。在完成任务后，分别给分享者和被分享者发放奖品。】我们可以根据这个例子，抽象出下面的模型。

## 人传人活动流程

分享者通过短信/社交软件等媒介，将人传人活动分享给被分享者。被分享者点击链接接受了邀请。接下来，会调用活动组件的活动申请接口，申请活动1，使二者建立联系。接着，被分享者会被要求完成“预设的”任务。之后，就是并行地调用活动组件的活动申请接口，申请活动2、活动3，来并行地给分享者和被分享者发奖。结果会用短信、推送之类的形式进行通知。

人传人活动应用的场景是很广的，比如说刚才香港钱包的例子就是一个拉新的场景。我们还有促活的场景，以美团为例。分享者支付完成一个外卖订单，在支付结果页分享红包，被分享者可以核销该红包。

这里有几个问题。首先，为什么要分成三个活动呢？第一，给分享者和被分享者发奖，首先需要记录二者关系，在活动1记录。接着，促使用户完成任务，再给被分享者和分享者发奖；活动2、3，给分享者和被分享者并行发奖。还有，为什么是活动2、3并行申请呢？我们有参考过其他的人传人活动设计方案，发现很多方案都采用先申请活动2、再申请活动3的串行申请方式。经过研究评估后，发现这样的设计有不合理之处：因为活动2申请会过风控组件、预算组件、计次组件、人群组件，都有可能申请失败，那么活动3就不能再进行申请。而事实上，活动2、3应该是独立、并行的关系，而非活动3依赖于活动2。

【停顿】此外我们可以看到，人传人活动本身的流程就是很长的。而且还要借助活动组件的活动申请，活动申请里面的也有非常多的步骤，比如要调用风控组件、预算组件等等。系统本身就有可能遇到网络中断、系统宕机（非业务性原因）等等，所以我们要保障人传人活动的一致性。

## 人传人活动申请单状态机

营销域里面，用户对发奖的感知不敏感，因此可以采用弱一致性+状态补偿的方案。接下来，继续对人传人活动流程进一步抽象，抽象出一个人传人活动申请状态机。整个人传人活动的流程，都依赖于申请单的状态进行推进。这里我只截取了我所做的活动2、3补偿的流程。

在被分享者完成任务后，申请单状态会推进到TASK_COMPLETED状态，然后进行活动2、3的申请。系统会根据活动申请的不同结果，将申请单状态推进到四个不同的终态。那么，如果在推进的过程中因为网络原因导致流程中断，怎么办？这里就要引入补偿的概念了：系统会捞取TASK_COMPLETED状态的申请单，让其继续执行流程，直到状态达到后面的4个最终态。

~~【申请单的初始状态就是INIT状态，然后在活动1申请成功后，进入RELATION_ESTABLISHED的最终态。接着被分享者完成任务后，系统监听消息，将申请单状态推进到TASK_COMPLETED。然后，根据活动2、3申请的不同结果，申请单会推进到4个不同的最终态。~~

~~那么，如果在推进的过程中因为网络原因导致流程中断，怎么办？这里就要引入补偿的概念了：我们系统会捞取中间态的活动申请单，然后让它继续执行，直到状态到达了最终态。比如，在我们的模型中，系统会捞取INIT状态的申请单，让其继续执行流程，直到达到RELATION_ESTABLISHED的最终态。系统会捞取TASK_COMPLETED状态的申请单，让其继续执行流程，直到状态达到后面的4个最终态。】~~

为了实现补偿，我们对数据模型进行了改造。对申请单数据模型新增了retry_count, shedule_time, lock_time三个字段。retry_count是调度的重试次数，如果超过一定次数，会选择人工介入。schedule_time，下一次调度，申请单能被捞取的时间。lock_time，业务锁的时间。只用悲观锁不能保证分布式事务，lock_time可以在我们执行流程时，有效阻止其他补偿线程的并发执行。

## scheduler三层分发任务

为什么会使用三层调用，而不是两层或一层呢？如果只有两层，那么任务拆分和捞取数据都在splitor层完成，而该层仅在一台机器上处理，如果数据库数量过大将导致该机器处理压力大。不用一层调用也是同样的道理。

对补偿的执行，我们这边使用的是scheduler的三层分发任务。首先，是它的整个结构。第一层splitor层会接受消息，发起RPC调用将任务分发到集群的loader层服务器。loader层会去捞取相应的数据，然后发起RPC调用集群的executor层服务器，让它们去执行具体的任务。对应到我们的业务当中，我们会在调度平台配置定时任务，splitor层接受捞取任务消息，分发任务给loader层服务器。loader层根据一定的条件去捞取人传人消息申请单，再调用executor层服务器，让它们去执行具体的补偿逻辑。

# 3 总结与展望

最后呢，是我在这段时间的实习总结，以及对未来的展望。

## 实习收获

好的开发要具备哪些东西？相对于之前都是一个人编写代码，如今在整个组织里面，知道如何协调其他同学一起完成任务。也了解到，在系统开发之前，模型设计、系分设计是最基础也最重要的。此外还有对代码结构，设计模式的了解。

规范的流程是一个优秀大厂的标志之一。在阿里，我们需要各个环境联调，会制定发布的计划，以及到后来整个系统开发的复盘总结。

业务上来说，我也熟悉了营销域中各个基础组件，如活动组件、奖品组件等等。广告投放也是营销里面，十分重要的一环。

技术上而言，技术是程序员的立身之本，蚂蚁中间件的学习也令我受益匪浅。

## 未来一年规划

最后是我对未来一年的规划。

在业务上，我希望可以继续参加系统的日常迭代，加深对系统的理解；把我们的系统和主站的系统进行比较，取长补短。

在架构能力上，可以参加系统架构的迭代，加深理解后，对系统架构提出自己的看法。

在产出上，成为一个业务系统owner，并产出专利、技术文档。



RPC框架的注册中心，只是把服务提供者地址列表给服务消费者，完全没必要用zookeeper做注册中心。注册中心不一致的情况，最糟的情况就是负载均衡打到别的服务提供者，对整体情况影响不大。zookeeper是CP系统强一致性，我们只需要一个AP系统即可。现在有的框架是，可以自己选择注册中心。


